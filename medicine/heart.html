<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>å¿ƒè·³æ¨¡æ“¬å™¨</title>
<style>
body { font-family: Arial; margin: 20px; }
.container { display: flex; gap: 20px; }

/* å·¦é‚Šå€å¡Š */
.left { flex: 2; } /* å·¦é‚Šè®Šå¤§ */
.right { flex: 1; max-height: 500px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; }

button { padding: 8px 16px; font-size: 16px; margin: 5px; }
#bpm { font-size: 24px; color: red; }
canvas { border: 1px solid #ccc; margin-top: 10px; width: 100%; }
table { border-collapse: collapse; width: 100%; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 4px; text-align: center; }
th { background-color: #f2f2f2; }
</style>
</head>
<body>

<h1>å¿ƒè·³æ¨¡æ“¬å™¨ + BPM æ­·å²è³‡æ–™</h1>

<div class="container">
    <!-- å·¦é‚Šï¼šå¿ƒè·³æ§åˆ¶ + åœ–è¡¨ -->
    <div class="left">
        <p>
            ç‹€æ…‹ï¼š
            <button onclick="setState('rest')">å¹³æ™‚</button>
            <button onclick="setState('exercise')">é‹å‹•</button>
            <button onclick="resetData()">ğŸ”„ é‡ç½®</button>
        </p>
        <p>ç›®å‰å¿ƒç‡ (BPM): <span id="bpm">0</span></p>
        <canvas id="bpmChart" width="600" height="400"></canvas>
    </div>

    <!-- å³é‚Šï¼šBPM æ­·å²è³‡æ–™ -->
    <div class="right">
        <h3>BPM æ­·å²è³‡æ–™ (bpmHistory)</h3>
        <table id="bpmTable">
            <tr><th>#</th><th>æ™‚é–“ (ms)</th><th>BPM</th></tr>
        </table>
    </div>
</div>

<script>
let bpmHistory = [];
let state = 'rest';
const bpmSpan = document.getElementById("bpm");
const canvas = document.getElementById("bpmChart");
const ctx = canvas.getContext("2d");

// ç‹€æ…‹åˆ‡æ›
function setState(s) {
    state = s;
}

// ç”Ÿæˆå¿ƒè·³è³‡æ–™
function generateHeartbeat() {
    const now = Date.now();

    // æ ¹æ“šç‹€æ…‹ç”Ÿæˆ BPM
    let bpm;
    if(state==='rest') bpm = Math.floor(Math.random() * (80-55+1)) + 55;
    else bpm = Math.floor(Math.random() * (150-90+1)) + 90;

    bpmHistory.push({time: now, bpm: bpm});

    // ä¿ç•™æœ€è¿‘50å€‹é»
    if(bpmHistory.length>50) bpmHistory.shift();

    bpmSpan.textContent = bpm;

    updateTable();
    drawChart();
}

// é‡ç½®
function resetData() {
    bpmHistory = [];
    bpmSpan.textContent = 0;
    updateTable();
    drawChart();
}

// æ›´æ–°å³é‚Šè¡¨æ ¼
function updateTable() {
    const bpmTable = document.getElementById("bpmTable");
    bpmTable.innerHTML = "<tr><th>#</th><th>æ™‚é–“ (ms)</th><th>BPM</th></tr>";
    bpmHistory.forEach((entry,i)=>{
        const row = bpmTable.insertRow();
        row.insertCell(0).textContent = i+1;
        row.insertCell(1).textContent = entry.time;
        row.insertCell(2).textContent = entry.bpm;
    });

    // è‡ªå‹•æ»¾åˆ°æœ€å¾Œ
    bpmTable.parentElement.scrollTop = bpmTable.parentElement.scrollHeight;
}

// ç•«æŠ˜ç·šåœ–
function drawChart() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if(bpmHistory.length===0) return;

    const maxBPM = Math.max(...bpmHistory.map(e=>e.bpm))+10;
    const minBPM = Math.min(...bpmHistory.map(e=>e.bpm))-10;
    const padding = 30;
    const width = canvas.width - 2*padding;
    const height = canvas.height - 2*padding;
    const stepX = width / (bpmHistory.length-1 || 1);

    ctx.beginPath();
    ctx.strokeStyle = "red";
    ctx.lineWidth = 2;
    bpmHistory.forEach((e,i)=>{
        const x = padding + i*stepX;
        const y = padding + height - (e.bpm - minBPM)/(maxBPM-minBPM)*height;
        if(i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
    });
    ctx.stroke();

    // Xè»¸
    ctx.strokeStyle = "#000";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(padding, canvas.height-padding);
    ctx.lineTo(canvas.width-padding, canvas.height-padding);
    ctx.stroke();

    // Yè»¸æ¨™ç±¤
    ctx.fillStyle = "#000";
    ctx.font = "14px Arial";
    ctx.fillText(maxBPM, 5, padding+5);
    ctx.fillText(minBPM, 5, canvas.height-padding);
}

// æ¯ç§’ç”Ÿæˆå¿ƒè·³
setInterval(generateHeartbeat, 1000);
</script>

</body>
</html>
